<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Confirmed!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .success-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        .checkmark {
            color: white;
            font-size: 40px;
            font-weight: bold;
        }
        
        h1 {
            color: #212529;
            margin-bottom: 15px;
            font-size: 32px;
        }
        
        .message {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .detail-label {
            font-weight: 600;
        }
        
        .calendar-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .calendar-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .calendar-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .calendar-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: white;
            color: #495057;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }
        
        .calendar-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .home-button {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .home-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .secondary-button {
            display: inline-block;
            padding: 15px 30px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .secondary-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            color: #6c757d;
            margin-top: 20px;
        }
        
        @media (max-width: 480px) {
            .calendar-buttons {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .success-card {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="success-card">
        <div class="success-icon">
            <span class="checkmark">‚úì</span>
        </div>
        
        <h1>Booking Confirmed!</h1>
        
        <p class="message">
            Thank you for your booking! You'll receive a confirmation email shortly with all the details.
        </p>
        
        <div class="details" id="bookingDetails" style="display: none;">
            <div class="detail-item">
                <span class="detail-label">Booking Reference:</span>
                <span id="bookingRef">-</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Amount Paid:</span>
                <span id="amountPaid">-</span>
            </div>
        </div>
        
        <div class="calendar-section" id="calendarSection" style="display: none;">
            <div class="calendar-title">üìÖ Add to Calendar</div>
            <div class="calendar-buttons">
                <a href="#" id="googleCalendar" class="calendar-btn">
                    üìÖ Google Calendar
                </a>
                <a href="#" id="outlookCalendar" class="calendar-btn">
                    üìÖ Outlook
                </a>
                <a href="#" id="appleCalendar" class="calendar-btn">
                    üìÖ Apple Calendar
                </a>
                <a href="#" id="downloadIcs" class="calendar-btn">
                    üíæ Download .ics
                </a>
            </div>
        </div>
        
        <p class="message">
            A confirmation email has been sent to your email address with all the event details and your booking reference.
        </p>
        
        <div class="loading" id="updatingStatus">
            <p>Updating booking system...</p>
        </div>
        
        <div class="button-group">
            <a href="https://www.thenbrh.co.uk/" class="home-button">
                üè† Back to Home
            </a>
        </div>
    </div>
    
    <script>
        /* 
        DYNAMIC CALENDAR - GOOGLE SHEETS INTEGRATION
        
        This page fetches booking details from your Google Sheet via API:
        GET /api/booking-details?session_id=pi_3RyElu4ajNC0yBi40vVgd11i
        
        Note: session_id parameter should be the Stripe payment ID (stripe_payment_id from your sheet)
        
        Expected API Response:
        {
            "event_title": "Kids Tennis Camp",
            "event_description": "Fun tennis camp for kids with professional coaching and equipment\n\nIncluded Add-ons: Ball Set",
            "event_location": "NBRH Tennis Courts, Main Location",
            "start_date": "2025-01-30T09:00:00Z",
            "end_date": "2025-01-30T12:00:00Z",
            "amount_paid": "¬£19.5",
            "customer_name": "Adam",
            "customer_email": "kennedy_adamu@yahoo.co.uk",
            "booking_id": "CS_TEST_",
            "addons_selected": "Ball Set"
        }
        */

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        
        // Dynamic event details - will be populated from Google Sheets API
        let eventDetails = {
            title: "Your Booked Session",
            description: "Thank you for booking with us!",
            location: "TBC",
            startDate: new Date(),
            endDate: new Date(Date.now() + 2 * 60 * 60 * 1000),
        };
        
        // Fetch event details from your Google Sheets API
        async function fetchEventDetailsFromAPI(sessionId) {
            try {
                // Show loading state
                showLoadingState(true);
                
                const response = await fetch(`/api/booking-details?session_id=${sessionId}`);
                if (response.ok) {
                    const bookingData = await response.json();
                    
                    console.log('Raw API response:', bookingData);
                    
                    // Update event details with data from Google Sheets
                    eventDetails = {
                        title: bookingData.event_title || 'Your Booked Session',
                        description: bookingData.event_description || 'Thank you for booking with us!',
                        location: bookingData.event_location || 'TBC',
                        startDate: bookingData.start_date ? new Date(bookingData.start_date) : new Date(),
                        endDate: bookingData.end_date ? new Date(bookingData.end_date) : new Date(Date.now() + 2 * 60 * 60 * 1000),
                    };
                    
                    console.log('Updated eventDetails:', eventDetails);
                    
                    // Update displayed booking details
                    if (bookingData.amount_paid) {
                        document.getElementById('amountPaid').textContent = bookingData.amount_paid;
                    }
                    
                    console.log('Event details loaded from Google Sheets successfully');
                    showLoadingState(false); // This will handle setupCalendarLinks
                    
                } else {
                    console.warn('Could not fetch booking details from API, response:', response.status);
                    // Use default placeholder data but still set up calendar
                    console.log('Using placeholder eventDetails:', eventDetails);
                    showLoadingState(false);
                }
            } catch (error) {
                console.error('Error fetching booking details:', error);
                // Use default placeholder data but still set up calendar
                console.log('Error occurred, using placeholder eventDetails:', eventDetails);
                showLoadingState(false);
            }
        }
        
        // Show/hide loading state for calendar section
        function showLoadingState(loading) {
            const calendarSection = document.getElementById('calendarSection');
            const calendarButtons = document.querySelector('.calendar-buttons');
            
            if (loading) {
                calendarButtons.innerHTML = '<div style="color: #6c757d; padding: 10px;">Loading event details...</div>';
            } else {
                // Restore calendar buttons (setupCalendarLinks will populate them)
                calendarButtons.innerHTML = `
                    <a href="#" id="googleCalendar" class="calendar-btn">üìÖ Google Calendar</a>
                    <a href="#" id="outlookCalendar" class="calendar-btn">üìÖ Outlook</a>
                    <a href="#" id="appleCalendar" class="calendar-btn">üìÖ Apple Calendar</a>
                    <a href="#" id="downloadIcs" class="calendar-btn">üíæ Download .ics</a>
                `;
                
                // Wait a moment for DOM to update, then setup calendar links
                setTimeout(() => {
                    setupCalendarLinks();
                }, 100);
            }
        }
        
        // Initialize the page
        async function initializePage() {
            if (sessionId) {
                // Show booking reference (first 8 characters of session ID)
                const bookingRef = sessionId.substring(0, 8).toUpperCase();
                document.getElementById('bookingRef').textContent = bookingRef;
                document.getElementById('bookingDetails').style.display = 'block';
                
                // Show calendar section
                document.getElementById('calendarSection').style.display = 'block';
                
                // DON'T set up calendar links yet - wait for API data
                showLoadingState(true);
                
                // Load dynamic event details from Google Sheets FIRST
                await fetchEventDetailsFromAPI(sessionId);
                
                // Update the booking in Google Sheets
                updateBookingRecord(sessionId);
            }
        }
        
        // Start initialization
        initializePage();
        
        function setupCalendarLinks() {
            console.log('Setting up calendar links with eventDetails:', eventDetails);
            
            const { title, description, location, startDate, endDate } = eventDetails;
            
            // Check if calendar buttons exist before setting up links
            const googleCalendar = document.getElementById('googleCalendar');
            const outlookCalendar = document.getElementById('outlookCalendar');
            const appleCalendar = document.getElementById('appleCalendar');
            const downloadIcs = document.getElementById('downloadIcs');
            
            if (!googleCalendar || !outlookCalendar || !appleCalendar || !downloadIcs) {
                console.log('Calendar buttons not found, skipping setup');
                return;
            }
            
            console.log('Calendar data being used:', {
                title: title,
                description: description,
                location: location,
                startDate: startDate,
                endDate: endDate
            });
            
            // Format dates for calendar links
            const formatDate = (date) => {
                const formatted = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                console.log('Formatted date:', date, '‚Üí', formatted);
                return formatted;
            };
            
            const startFormatted = formatDate(startDate);
            const endFormatted = formatDate(endDate);
            
            // Google Calendar
            const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startFormatted}/${endFormatted}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
            googleCalendar.href = googleUrl;
            console.log('Google Calendar URL:', googleUrl);
            
            // Outlook Calendar
            const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(title)}&startdt=${startFormatted}&enddt=${endFormatted}&body=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
            outlookCalendar.href = outlookUrl;
            console.log('Outlook Calendar URL:', outlookUrl);
            
            // Apple Calendar and Download ICS - remove existing event listeners first
            appleCalendar.replaceWith(appleCalendar.cloneNode(true));
            downloadIcs.replaceWith(downloadIcs.cloneNode(true));
            
            // Re-get elements after cloning
            const newAppleCalendar = document.getElementById('appleCalendar');
            const newDownloadIcs = document.getElementById('downloadIcs');
            
            newAppleCalendar.addEventListener('click', downloadIcsFile);
            newDownloadIcs.addEventListener('click', downloadIcsFile);
            
            console.log('Calendar links setup complete with real data');
        }
        
        function downloadIcsFile(e) {
            e.preventDefault();
            
            const { title, description, location, startDate, endDate } = eventDetails;
            
            console.log('Downloading ICS file with data:', {
                title, description, location, startDate, endDate
            });
            
            // Create ICS content
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Your Company//Your App//EN
BEGIN:VEVENT
UID:${sessionId || Math.random().toString(36)}@yourcompany.com
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTEND:${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
SUMMARY:${title}
DESCRIPTION:${description}
LOCATION:${location}
END:VEVENT
END:VCALENDAR`;
            
            console.log('ICS content:', icsContent);
            
            // Create and download file
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `booking-${sessionId || 'event'}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            console.log('ICS file download initiated');
        }
        
        async function updateBookingRecord(sessionId) {
            document.getElementById('updatingStatus').style.display = 'block';
            
            try {
                // Call webhook to update Google Sheets
                await fetch('/api/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        type: 'booking.confirmed'
                    })
                });
                
                document.getElementById('updatingStatus').style.display = 'none';
                
            } catch (error) {
                console.error('Failed to update booking record:', error);
                document.getElementById('updatingStatus').style.display = 'none';
            }
        }
    </script>
</body>
</html>
