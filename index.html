<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkout</title>
    <!-- Open Graph tags for social sharing -->
    <meta property="og:title" content="Book Your Session" id="ogTitle" />
    <meta property="og:description" content="Join this exciting session - Book your spot now!" id="ogDescription" />
    <meta property="og:image" content="" id="ogImage" />
    <meta property="og:url" content="" id="ogUrl" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="" id="twitterImage" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f5f5f7;min-height:100vh}
        .header{background:#1c1c1e;color:#fff;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .header h1{font-size:18px;font-weight:600;text-align:center;flex:1}
        .header .close-btn{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:5px}
        .header .help-btn{background:none;border:1px solid #48484a;color:#fff;font-size:16px;cursor:pointer;padding:5px;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
        .booking-container{max-width:500px;margin:0 auto;padding:20px;background:#f5f5f7}
        .card{background:#fff;border-radius:12px;margin-bottom:15px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .event-card{padding:0;overflow:hidden}
        .event-image{width:100%;height:240px;object-fit:cover;display:block;background:#e5e5e7}
        .event-image.loading{background:linear-gradient(90deg,#e5e5e7 25%,#f0f0f2 50%,#e5e5e7 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .event-content{padding:20px}
        .event-details{width:100%}
        .event-title{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:8px;line-height:1.3}
        .event-meta-item{display:flex;align-items:center;margin-bottom:4px;color:#8e8e93;font-size:14px}
        .event-meta-item span{margin-right:8px}
        .event-more-info{margin-top:12px}
        .more-info-link{display:block;width:100%;padding:10px 12px;background:#FF006E;color:#fff;text-decoration:none;border-radius:3px;font-size:14px;font-weight:500;text-align:center;transition:opacity .2s}
        .more-info-link:hover{opacity:0.9}
        .club-link{display:block;width:100%;padding:10px 12px;background:#fff;color:#1c1c1e;border:1px solid #d1d1d6;text-decoration:none;border-radius:3px;font-size:14px;font-weight:500;text-align:center;transition:all .2s;margin-top:8px}
        .club-link:hover{background:#f5f5f7}
        .share-button{display:block;width:100%;padding:10px 12px;background:#fff;color:#1c1c1e;border:1px solid #d1d1d6;border-radius:3px;font-size:14px;font-weight:500;text-align:center;transition:all .2s;margin-top:8px;cursor:pointer}
        .share-button:hover{background:#f5f5f7}
        .share-button:active{transform:scale(0.98)}
        .share-success{background:#ffe8f5;color:#FF006E;padding:8px 12px;border-radius:6px;font-size:13px;text-align:center;margin-top:8px;animation:fadeIn 0.3s}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .ticket-info{margin-top:15px;padding:20px;padding-top:15px;border-top:1px solid #f2f2f7}
        .ticket-line{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .ticket-quantity,.ticket-price{font-size:16px;font-weight:600;color:#1c1c1e}
        .booking-fee{font-size:14px;color:#8e8e93;margin-left:20px}
        .spots-indicator{margin-top:10px;padding:8px 12px;border-radius:6px;font-size:14px;font-weight:500;text-align:center}
        .spots-available{background:#e8f5e8;color:#30a330}
        .spots-low{background:#fff4e5;color:#ff9500}
        .spots-out{background:#ffeaea;color:#ff3b30}
        .membership-badge{background:linear-gradient(135deg,#FF006E,#FF3380);color:white;padding:8px 12px;border-radius:6px;font-size:13px;font-weight:600;margin-top:12px;display:inline-block;text-transform:uppercase;letter-spacing:0.5px}
        .pricing-note{margin-top:8px;padding:10px;background:#fff4e5;border-left:3px solid #ff9500;border-radius:4px;font-size:13px;color:#ff9500;font-weight:500}
        .date-selector-card{padding:20px}
        .date-selector-card h3{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:15px}
        .date-select-wrapper{position:relative}
        .date-select{width:100%;padding:12px 16px;border:1px solid #d1d1d6;border-radius:8px;font-size:16px;background:#fff;transition:border-color .2s;appearance:none;cursor:pointer;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 12px center;background-size:20px;padding-right:40px}
        .date-select:focus{outline:none;border-color:#007aff}
        .date-select.valid{border-color:#30a330}
        .date-info{margin-top:10px;font-size:13px;color:#8e8e93;font-style:italic}
        .date-warning{margin-top:10px;padding:10px;background:#fff4e5;border-left:3px solid #ff9500;border-radius:4px;font-size:13px;color:#ff9500}
        .notes-card{padding:20px}
        .notes-card h3{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .notes-content{font-size:14px;color:#1c1c1e;line-height:1.6;white-space:pre-wrap}
        .attendees-preview-card{padding:20px}
        .attendees-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .attendees-header h3{font-size:16px;font-weight:600;color:#1c1c1e;margin:0}
        .attendees-count{font-size:14px;color:#007aff;font-weight:600}
        .attendees-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:12px;margin-bottom:15px}
        .attendees-grid.empty{display:block}
        .attendee-item{text-align:center}
        .attendee-avatar{width:60px;height:60px;background:linear-gradient(135deg,#007aff,#5ac8fa);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:18px;margin:0 auto 6px}
        .attendee-name{font-size:12px;color:#8e8e93;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .attendees-empty{text-align:center;padding:30px 20px;color:#8e8e93;max-width:100%;width:100%}
        .attendees-empty-icon{font-size:40px;margin-bottom:10px}
        .attendees-empty-text{font-size:14px;line-height:1.6;max-width:300px;margin:0 auto}
        .skill-distribution{margin-top:15px;padding-top:15px;border-top:1px solid #f2f2f7}
        .skill-bar-container{display:flex;align-items:center;gap:10px}
        .skill-label{font-size:12px;color:#8e8e93;min-width:80px}
        #skillBars{flex:1;display:flex;gap:4px;flex-wrap:wrap}
        .skill-tag{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:500;white-space:nowrap}
        .skill-beginner{background:#e8f4fd;color:#007aff}
        .skill-intermediate{background:#fff4e5;color:#ff9500}
        .skill-advanced{background:#ffe8f5;color:#ff006e}
        .skill-advanced-plus{background:#e8f5e8;color:#30a330}
        .view-all-link{display:block;text-align:center;color:#007aff;font-size:14px;font-weight:500;text-decoration:none;padding:10px;margin-top:10px;border-top:1px solid #f2f2f7;transition:opacity .2s}
        .view-all-link:hover{opacity:0.7}
        .customer-card{padding:20px}
        .customer-card h3{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:15px}
        .form-group{margin-bottom:15px}
        .form-label{display:block;margin-bottom:6px;font-size:14px;color:#1c1c1e;font-weight:500}
        .form-input{width:100%;padding:12px 16px;border:1px solid #d1d1d6;border-radius:8px;font-size:16px;background:#fff;transition:border-color .2s}
        .form-input:focus{outline:none;border-color:#007aff}
        .form-input.valid{border-color:#30a330}
        .skill-level-info{margin-top:5px;font-size:12px;color:#8e8e93;font-style:italic}
        .price-card{padding:20px}
        .price-card h3{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:15px}
        .price-line{display:flex;justify-content:space-between;margin-bottom:8px;color:#8e8e93;font-size:14px}
        .price-line.total{color:#1c1c1e;font-weight:600;font-size:16px;margin-top:10px;padding-top:10px;border-top:1px solid #f2f2f7}
        .discount-line{display:flex;justify-content:space-between;margin-bottom:8px;color:#30a330;font-size:14px;font-weight:500}
        .discount-card{padding:20px}
        .discount-card h3{font-size:16px;color:#007aff;margin-bottom:15px;font-weight:500}
        .discount-input-group{display:flex;gap:10px;margin-bottom:10px}
        .discount-input{flex:1;padding:12px 16px;border:1px solid #d1d1d6;border-radius:8px;font-size:16px;text-transform:uppercase}
        .apply-btn{padding:12px 20px;background:#007aff;color:#fff;border:none;border-radius:8px;font-weight:500;cursor:pointer;white-space:nowrap}
        .apply-btn:disabled{background:#8e8e93;cursor:not-allowed}
        .discount-message{margin-top:10px;padding:10px;border-radius:6px;font-size:14px}
        .discount-success{background:#e8f5e8;color:#30a330}
        .discount-error{background:#ffeaea;color:#ff3b30}
        .addons-card{padding:20px}
        .addons-card h3{font-size:16px;font-weight:600;color:#1c1c1e;margin-bottom:15px}
        .addon-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #f2f2f7;cursor:pointer}
        .addon-item:last-child{border-bottom:none}
        .addon-checkbox{margin-right:12px}
        .addon-details{flex:1}
        .addon-name{font-size:14px;color:#1c1c1e}
        .addon-price{font-size:14px;color:#8e8e93;font-weight:500}
        .payment-section{padding:0 20px 20px}
        .pay-button{width:100%;padding:16px;background:#FF006E;color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .pay-button:disabled{background:#8e8e93;cursor:not-allowed}
        .loading{text-align:center;padding:60px 20px;color:#8e8e93}
        .loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #007aff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .error-message{background:#ffeaea;color:#ff3b30;padding:20px;border-radius:12px;margin:20px;text-align:center}
        @media (max-width:640px){.booking-container{padding:15px}.event-image{height:200px}.attendees-grid{grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:8px}.attendee-avatar{width:50px;height:50px;font-size:16px}}
    </style>
</head>
<body>
    <div class="header">
        <button class="close-btn" onclick="window.history.back()">‚Üê</button>
        <h1>Checkout</h1>
        <button class="help-btn"></button>
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading booking form...</p>
    </div>
    <div id="error" class="error-message" style="display:none;"></div>

    <div class="booking-container" id="bookingForm" style="display:none;">
        <!-- Event Details Card -->
        <div class="card event-card">
            <img id="eventImage" class="event-image loading" alt="Event image" style="display:none;">
            
            <div class="event-content">
                <div class="event-details">
                    <div class="event-title" id="eventTitle">Event Name</div>
                    <div class="event-meta-item"><span>üìç</span><span id="eventLocation">Location</span></div>
                    <div class="event-meta-item"><span>üìÖ</span><span id="eventDateTime">Select a date to see details</span></div>
                    <div class="event-meta-item"><span>‚è∞</span><span id="eventDuration">Duration</span></div>
                    
                    <div class="event-more-info" id="eventMoreInfo" style="display:none;">
                        <a href="#" id="moreInfoLink" class="more-info-link">
                            Click here to book direct
                        </a>
                    </div>
                    
                    <div class="event-more-info" id="clubLinkContainer" style="display:none;">
                        <a href="#" id="clubLink" class="club-link">
                            Visit Club Page
                        </a>
                    </div>
                    
                    <div class="event-more-info">
                        <button id="shareButton" class="share-button" onclick="shareSession()">
                            üì§ Share this session
                        </button>
                        <div id="shareSuccess" class="share-success" style="display:none;">
                            Link copied to clipboard!
                        </div>
                    </div>
                </div>
            </div>
            <div class="ticket-info">
                <div class="ticket-line"><span class="ticket-quantity">1x Adult (16+)</span><span class="ticket-price" id="ticketPrice">¬£0.00</span></div>
                <div class="booking-fee"><span>1x Booking fees: ¬£<span id="bookingFeeAmount">0.00</span></span></div>
                <div class="spots-indicator" id="spotsIndicator"><span id="spotsText">Select a date to check availability</span></div>
                
                <!-- Membership/Bundle Indicator -->
                <div id="membershipBadge" style="display: none;">
                    <div class="membership-badge">üé´ Membership Required</div>
                    <div class="pricing-note" id="pricingNote"></div>
                </div>
            </div>
        </div>

        <!-- Date Selector Card -->
        <div class="card date-selector-card">
            <h3>üìÖ Select Your Date</h3>
            <div class="date-select-wrapper">
                <select id="dateSelect" class="date-select" onchange="onDateSelected()" required>
                    <option value="" selected disabled>Choose an available date...</option>
                </select>
            </div>
            <div class="date-info" id="dateInfo">Please select a date to continue</div>
            <div class="date-warning" id="dateWarning" style="display:none;"></div>
        </div>

        <!-- Notes Card -->
        <div class="card notes-card" id="notesCard" style="display:none;">
            <h3>üìù Important Information</h3>
            <div class="notes-content" id="notesContent"></div>
        </div>

        <!-- Attendees Preview Card -->
        <div class="card attendees-preview-card" id="attendeesPreviewCard" style="display:none;">
            <div class="attendees-header">
                <h3>Who's Coming?</h3>
                <div class="attendees-count" id="attendeesCount">0 people attending</div>
            </div>
            
            <div id="attendeesContent">
                <div class="attendees-grid" id="attendeesGrid">
                    <!-- Attendees will be populated here -->
                </div>
                
                <div class="skill-distribution" id="skillDistribution" style="display:none;">
                    <div class="skill-bar-container">
                        <div class="skill-label">Skill Levels:</div>
                        <div id="skillBars"></div>
                    </div>
                </div>
            </div>
            
            <a href="#" id="viewAllAttendeesLink" class="view-all-link" style="display:none;">
                View full community info ‚Üí
            </a>
        </div>

        <!-- Customer Information -->
        <div class="card customer-card">
            <h3>Your Details</h3>
            <div class="form-group">
                <label class="form-label" for="customerName">Full Name *</label>
                <input type="text" id="customerName" class="form-input" required placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label class="form-label" for="customerEmail">Email Address *</label>
                <input type="email" id="customerEmail" class="form-input" required placeholder="your.email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label" for="skillLevel">Skill Level *</label>
                <select id="skillLevel" class="form-input" required onchange="onSkillLevelChange()">
                    <option value="" selected disabled>Select your skill level</option>
                    <option value="Beginner">Beginner - New to this activity</option>
                    <option value="Intermediate">Intermediate - Some experience</option>
                    <option value="Advanced">Advanced - Very experienced</option>
                    <option value="Advanced+">Advanced+ - Expert level</option>
                </select>
                <div class="skill-level-info">Your skill level helps us provide the best experience for you</div>
            </div>
        </div>

        <!-- Add-ons -->
        <div class="card addons-card" id="addonsSection" style="display:none;">
            <h3>Optional Add-ons</h3>
            <div id="addonsList"></div>
        </div>

        <!-- Price Details -->
        <div class="card price-card">
            <h3>Price details</h3>
            <div id="priceBreakdown">
                <div class="price-line"><span>Tickets:</span><span id="ticketsPrice">¬£0.00</span></div>
                <div class="price-line"><span>Booking fee:</span><span id="feePrice">¬£0.00</span></div>
            </div>
            <div class="price-line total"><span>Total</span><span id="totalPrice">¬£0.00</span></div>
        </div>

        <!-- Discount Code -->
        <div class="card discount-card">
            <h3>Apply a voucher, gift card or discount code</h3>
            <div class="discount-input-group">
                <input type="text" id="discountCode" class="discount-input" placeholder="Enter code" maxlength="20">
                <button id="applyDiscountBtn" class="apply-btn" onclick="applyDiscountCode()">Apply</button>
            </div>
            <div id="discountMessage" class="discount-message" style="display:none;"></div>
        </div>
    </div>

    <!-- Payment Section -->
    <div class="payment-section" id="paymentSection" style="display:none;">
        <button id="payButton" class="pay-button" onclick="processBooking()" disabled>Select a date to continue</button>
    </div>

    <script>
        // ===== Config =====
        const SHEET_ID = '1P4fON7qVFQt_w9OKoTiweLaT3GkpF9viS910E93BD48';
        const API_KEY = 'AIzaSyDK2LyxRj64ILoXIO37OJyo9qgjWyq18cU';

        // ===== State =====
        let sessionTemplate = null;
        let availableSessions = [];
        let selectedSession = null;
        let selectedAddons = [];
        let appliedDiscount = null;
        let currentSkillLevel = '';
        let attendeesData = [];

        // ===== Boot =====
        const urlParams = new URLSearchParams(window.location.search);
        let sessionId = urlParams.get('event');
        
        if (!sessionId) {
            showError('No session specified. Please use a valid booking link.');
        } else {
            if (sessionId.startsWith('NBRH')) {
                console.log('Detected NBRH ID format, converting to Session ID...');
                convertNbrhToSessionId(sessionId);
            } else {
                loadSessionData();
            }
        }

        async function convertNbrhToSessionId(nbrhId) {
            try {
                const cleanNbrhId = nbrhId.split(':')[0];
                console.log('Looking up NBRH ID:', cleanNbrhId, '(original:', nbrhId + ')');
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sessions!A:AV?key=${API_KEY}`);
                
                if (!response.ok) throw new Error('Failed to load sessions data');
                
                const data = await response.json();
                const rows = data.values;
                
                for (let i = 1; i < rows.length; i++) {
                    const rowNbrhId = rows[i][0];
                    if (rowNbrhId === nbrhId || rowNbrhId === cleanNbrhId || rowNbrhId.split(':')[0] === cleanNbrhId) {
                        const foundSessionId = rows[i][43];
                        console.log('Found Session ID:', foundSessionId, 'for NBRH ID:', rowNbrhId);
                        sessionId = foundSessionId;
                        loadSessionData();
                        return;
                    }
                }
                
                console.error('NBRH ID not found in Sessions sheet. Searched for:', nbrhId, 'and', cleanNbrhId);
                showError('Session not found. This booking link may no longer be valid.');
                
            } catch (error) {
                console.error('Error converting NBRH ID:', error);
                showError('Unable to load session details. Please try again later.');
            }
        }

        async function loadSessionData() {
            try {
                console.log('Loading session template:', sessionId);
                
                const [templatesResponse, sessionsResponse, bookingsResponse] = await Promise.all([
                    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Session Templates!A:AV?key=${API_KEY}`),
                    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sessions!A:AV?key=${API_KEY}`),
                    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Bookings!A:M?key=${API_KEY}`)
                ]);

                if (!templatesResponse.ok) throw new Error('Failed to load session template data');
                if (!sessionsResponse.ok) throw new Error('Failed to load sessions data');
                
                const templatesData = await templatesResponse.json();
                const sessionsData = await sessionsResponse.json();
                
                const templateRows = templatesData.values;
                let templateRow = null;
                
                for (let i = 1; i < templateRows.length; i++) {
                    if (templateRows[i][43] === sessionId) {
                        templateRow = templateRows[i];
                        break;
                    }
                }
                
                if (!templateRow) {
                    showError('Session not found or no longer available.');
                    return;
                }

                sessionTemplate = parseSessionRow(templateRow);
                console.log('Session template loaded:', sessionTemplate);

                const sessionRows = sessionsData.values;
                availableSessions = [];
                
                for (let i = 1; i < sessionRows.length; i++) {
                    const row = sessionRows[i];
                    if (row[43] === sessionId && row[35] === 'General Access' && row[34] === 'ENQUIRE') {
                        const session = parseSessionRow(row);
                        availableSessions.push(session);
                    }
                }

                console.log(`Found ${availableSessions.length} available dates for this session`);

                if (availableSessions.length === 0) {
                    showError('No available dates for this session at the moment.');
                    return;
                }

                availableSessions.sort((a, b) => new Date(parseUKDate(a.date)) - new Date(parseUKDate(b.date)));

                if (bookingsResponse.ok) {
                    const bookingsData = await bookingsResponse.json();
                }

                displaySessionTemplate();
                populateDateDropdown();
                
            } catch (error) {
                console.error('Error:', error);
                showError('Unable to load session details. Please try again later.');
            }
        }

        function parseSessionRow(row) {
            return {
                nbrhId: row[0],
                activityType: row[1],
                club: row[2],
                className: row[3],
                date: row[4],
                startTime: row[5],
                duration: row[6],
                address: row[7],
                location: row[8],
                basePrice: parseFloat(row[9]) || 0,
                discount: row[10],
                totalPrice: parseFloat(row[11]) || 0,
                spotsAvailable: parseInt(row[12]) || 0,
                totalSpots: parseInt(row[13]) || 0,
                difficultyLevel: row[14],
                bookingUrl: row[15],
                website: row[16],
                imageUrl: row[17],
                ageGroup: row[18],
                equipmentProvided: row[19],
                cancellationHours: row[20],
                indoorOutdoor: row[21],
                badge: row[22],
                audience: row[23],
                userRating: row[24],
                nbrhRating: row[25],
                vibe: row[26],
                sportsmanshipScore: row[27],
                organisationScore: row[28],
                competitivenessScore: row[29],
                equipmentVenuesScore: row[30],
                friendlinessScore: row[31],
                skillLevelScore: row[32],
                reviewCount: row[33],
                bookEasyBook: row[34],
                sessionStatus: row[35],
                sponsored: row[36],
                type: row[37],
                latitude: row[38],
                longitude: row[39],
                notes: row[40] || '',
                bookingType: (row[46] || 'stripe').toLowerCase(),
                clubUrl: row[23] || '',
                sessionId: row[43],
                endTime: row[42] || '',
                transactionFee: parseFloat(row[47]) || 0
            };
        }

        function populateDateDropdown() {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '<option value="" selected disabled>Choose an available date...</option>';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            console.log('=== DATE FILTERING DEBUG ===');
            console.log('Today is:', today.toDateString());
            console.log(`Total sessions found: ${availableSessions.length}`);
            
            let futureSessionsCount = 0;
            let pastSessionsCount = 0;
            
            availableSessions.forEach((session, index) => {
                console.log(`\nSession ${index}:`, session.date);
                
                const sessionDate = parseUKDate(session.date);
                sessionDate.setHours(0, 0, 0, 0);
                
                console.log('  Parsed as:', sessionDate.toDateString());
                console.log('  Comparison:', sessionDate.getTime(), 'vs', today.getTime());
                console.log('  Is in past?', sessionDate < today);
                
                if (sessionDate < today) {
                    console.log('  ‚ùå SKIPPED - Past date');
                    pastSessionsCount++;
                    return;
                }
                
                console.log('  ‚úÖ INCLUDED - Future date');
                futureSessionsCount++;
                
                const option = document.createElement('option');
                option.value = index;
                
                const formattedDate = formatDate(session.date);
                const timeDisplay = formatTimeDisplay(session.startTime, session.endTime);
                const spotsText = session.spotsAvailable > 0 
                    ? `(${session.spotsAvailable} spots left)`
                    : '(SOLD OUT)';
                
                option.textContent = `${formattedDate} at ${timeDisplay} ${spotsText}`;
                option.disabled = session.spotsAvailable <= 0;
                
                dateSelect.appendChild(option);
            });
            
            console.log('\n=== FILTERING SUMMARY ===');
            console.log(`Past dates filtered out: ${pastSessionsCount}`);
            console.log(`Future dates shown: ${futureSessionsCount}`);
            
            if (futureSessionsCount === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.disabled = true;
                option.textContent = 'No upcoming dates available';
                dateSelect.appendChild(option);
                console.log('‚ö†Ô∏è No future sessions available');
            }
        }

        function onDateSelected() {
            const dateSelect = document.getElementById('dateSelect');
            const selectedIndex = parseInt(dateSelect.value);
            
            if (isNaN(selectedIndex)) return;
            
            selectedSession = availableSessions[selectedIndex];
            console.log('Selected session:', selectedSession);
            console.log('Booking type:', selectedSession.bookingType);
            
            dateSelect.classList.add('valid');
            
            const timeDisplay = formatTimeDisplay(selectedSession.startTime, selectedSession.endTime);
            document.getElementById('eventDateTime').textContent = `${formatDate(selectedSession.date)} at ${timeDisplay}`;
            document.getElementById('eventLocation').textContent = `${selectedSession.location} ‚Ä¢ ${selectedSession.address || ''}`;
            
            const dateInfo = document.getElementById('dateInfo');
            dateInfo.textContent = `Selected: ${formatDate(selectedSession.date)} at ${timeDisplay}`;
            dateInfo.style.color = '#30a330';
            
            const sessionDate = parseUKDate(selectedSession.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (sessionDate < today) {
                const dateWarning = document.getElementById('dateWarning');
                dateWarning.textContent = '‚ö†Ô∏è This session date has passed. Please select a future date.';
                dateWarning.style.display = 'block';
                document.getElementById('payButton').disabled = true;
                return;
            } else {
                document.getElementById('dateWarning').style.display = 'none';
            }
            
            updateSpotsIndicator();
            loadAttendeesForSession(selectedSession.nbrhId);
            
            const payButton = document.getElementById('payButton');
            payButton.disabled = false;
            
            if (selectedSession.bookingType === 'direct') {
                payButton.innerHTML = 'Register Interest';
            } else {
                payButton.innerHTML = selectedSession.totalPrice === 0 ? 'Register Interest' : `Pay ¬£${selectedSession.totalPrice.toFixed(2)}`;
            }
            
            updatePricing();
        }

        function updateSpotsIndicator() {
            if (!selectedSession) return;
            
            const spotsIndicator = document.getElementById('spotsIndicator');
            const spotsText = document.getElementById('spotsText');
            
            if (selectedSession.spotsAvailable <= 0) {
                spotsIndicator.className = 'spots-indicator spots-out';
                spotsText.textContent = 'SOLD OUT - No spots available';
                document.getElementById('payButton').disabled = true;
            } else if (selectedSession.spotsAvailable <= 5) {
                spotsIndicator.className = 'spots-indicator spots-low';
                spotsText.textContent = `Hurry! Only ${selectedSession.spotsAvailable} spots left`;
            } else {
                spotsIndicator.className = 'spots-indicator spots-available';
                spotsText.textContent = `${selectedSession.spotsAvailable} spots available`;
            }
        }

        async function loadAttendeesForSession(nbrhId) {
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Bookings!A:M?key=${API_KEY}`);
                
                if (!response.ok) return;
                
                const bookingsData = await response.json();
                attendeesData = processAttendeesData(bookingsData.values, nbrhId);
                displayAttendees();
                
            } catch (error) {
                console.error('Error loading attendees:', error);
            }
        }

        function processAttendeesData(bookingsRows, nbrhId) {
            const attendees = [];
            
            if (!bookingsRows || bookingsRows.length < 2) return attendees;
            
            for (let i = 1; i < bookingsRows.length; i++) {
                const row = bookingsRows[i];
                if (row[2] === nbrhId && row[9] === 'Confirmed') {
                    attendees.push({
                        customerName: row[4] || 'Guest',
                        skillLevel: row[12] || 'Not specified',
                        addonsSelected: row[7] || 'None'
                    });
                }
            }
            
            return attendees;
        }

        function displaySessionTemplate() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'block';
            document.getElementById('paymentSection').style.display = 'block';

            const eventImage = document.getElementById('eventImage');
            if (sessionTemplate.imageUrl && sessionTemplate.imageUrl.trim() !== '') {
                eventImage.src = sessionTemplate.imageUrl;
                eventImage.style.display = 'block';
                eventImage.classList.remove('loading');
                
                eventImage.onerror = function() {
                    console.error('Failed to load event image:', sessionTemplate.imageUrl);
                    eventImage.style.display = 'none';
                };
            }

            document.getElementById('eventTitle').textContent = sessionTemplate.className;
            document.getElementById('eventLocation').textContent = sessionTemplate.location;
            
            const durationMinutes = parseInt(sessionTemplate.duration) || 0;
            const durationHours = Math.floor(durationMinutes / 60);
            const remainingMinutes = durationMinutes % 60;
            let durationText = '';
            if (durationHours > 0) {
                durationText = `${durationHours}h`;
                if (remainingMinutes > 0) durationText += ` ${remainingMinutes}m`;
            } else {
                durationText = `${durationMinutes} minutes`;
            }
            document.getElementById('eventDuration').textContent = durationText;

            document.getElementById('ticketPrice').textContent = `¬£${sessionTemplate.totalPrice.toFixed(2)}`;
            document.getElementById('bookingFeeAmount').textContent = sessionTemplate.transactionFee.toFixed(2);

            // Use website column for "Click here to book direct" link
            if (sessionTemplate.website && sessionTemplate.website.trim() !== '') {
                const moreInfoLink = document.getElementById('moreInfoLink');
                const moreInfoSection = document.getElementById('eventMoreInfo');
                
                let url = sessionTemplate.website.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                moreInfoLink.href = url;
                moreInfoSection.style.display = 'block';
            }

            if (sessionTemplate.website && sessionTemplate.website.trim() !== '') {
                const clubLink = document.getElementById('clubLink');
                const clubLinkContainer = document.getElementById('clubLinkContainer');
                
                let url = sessionTemplate.website.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                clubLink.href = url;
                clubLinkContainer.style.display = 'block';
            }

            if (sessionTemplate.notes && sessionTemplate.notes.trim() !== '') {
                const notesCard = document.getElementById('notesCard');
                const notesContent = document.getElementById('notesContent');
                notesContent.textContent = sessionTemplate.notes.trim();
                notesCard.style.display = 'block';
            }

            // Show membership/bundle indicator if type is "Clubs"
            if (sessionTemplate.type && sessionTemplate.type.toLowerCase() === 'clubs') {
                const membershipBadge = document.getElementById('membershipBadge');
                const pricingNote = document.getElementById('pricingNote');
                
                membershipBadge.style.display = 'block';
                
                const price = sessionTemplate.totalPrice.toFixed(2);
                pricingNote.textContent = `This is a membership or bundle price (¬£${price}). Please visit the club's website for full pricing details, terms, and what's included.`;
                
                document.getElementById('ticketPrice').innerHTML = `¬£${price} <span style="font-size:12px;color:#8e8e93;font-weight:normal;">(membership/bundle)</span>`;
            }

            updatePricing();
            updateShareMetaTags();
        }

        function displayAttendees() {
            const card = document.getElementById('attendeesPreviewCard');
            const grid = document.getElementById('attendeesGrid');
            const count = document.getElementById('attendeesCount');
            const skillDistribution = document.getElementById('skillDistribution');
            const viewAllLink = document.getElementById('viewAllAttendeesLink');
            
            if (attendeesData.length === 0) {
                grid.classList.add('empty');
                grid.innerHTML = `
                    <div class="attendees-empty">
                        <div class="attendees-empty-icon">üëã</div>
                        <div class="attendees-empty-text">Be the first to join! No one has booked yet.</div>
                    </div>
                `;
                count.textContent = 'Be the first!';
                card.style.display = 'block';
                return;
            }
            
            grid.classList.remove('empty');

            const attendeeText = attendeesData.length === 1 ? '1 person attending' : `${attendeesData.length} people attending`;
            count.textContent = attendeeText;

            const displayCount = Math.min(attendeesData.length, 8);
            let gridHTML = '';

            for (let i = 0; i < displayCount; i++) {
                const attendee = attendeesData[i];
                const firstName = attendee.customerName.split(' ')[0];
                const initials = attendee.customerName
                    .split(' ')
                    .map(name => name.charAt(0).toUpperCase())
                    .join('')
                    .substring(0, 2);

                gridHTML += `
                    <div class="attendee-item">
                        <div class="attendee-avatar">${initials}</div>
                        <div class="attendee-name">${firstName}</div>
                    </div>
                `;
            }

            if (attendeesData.length > 8) {
                gridHTML += `
                    <div class="attendee-item">
                        <div class="attendee-avatar">+${attendeesData.length - 8}</div>
                        <div class="attendee-name">more</div>
                    </div>
                `;
            }

            grid.innerHTML = gridHTML;
            displaySkillDistribution();

            if (selectedSession) {
                viewAllLink.href = `attendees-public.html?event=${selectedSession.nbrhId}`;
                viewAllLink.style.display = 'block';
            }

            card.style.display = 'block';
        }

        function displaySkillDistribution() {
            const skillCounts = {};
            attendeesData.forEach(attendee => {
                const skill = attendee.skillLevel || 'Not specified';
                skillCounts[skill] = (skillCounts[skill] || 0) + 1;
            });

            const skillKeys = Object.keys(skillCounts);
            if (skillKeys.length === 0) return;

            const skillBars = document.getElementById('skillBars');
            const skillDistribution = document.getElementById('skillDistribution');
            
            let skillHTML = '';
            
            const skillClasses = {
                'Beginner': 'skill-beginner',
                'Intermediate': 'skill-intermediate',
                'Advanced': 'skill-advanced',
                'Advanced+': 'skill-advanced-plus',
                'Not specified': 'skill-beginner'
            };

            skillKeys.sort().forEach(skill => {
                const count = skillCounts[skill];
                const cssClass = skillClasses[skill] || 'skill-beginner';
                skillHTML += `<span class="skill-tag ${cssClass}">${skill} (${count})</span>`;
            });

            skillBars.innerHTML = skillHTML;
            skillDistribution.style.display = 'block';
        }

        async function shareSession() {
            const shareUrl = window.location.href;
            const shareTitle = sessionTemplate.className;
            const shareText = `Check out this session: ${sessionTemplate.className}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: shareUrl
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        copyToClipboard(shareUrl);
                    }
                }
            } else {
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showShareSuccess();
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-1000px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showShareSuccess();
            } catch (error) {
                alert('Failed to copy link. Please copy manually: ' + text);
            }

            document.body.removeChild(textArea);
        }

        function showShareSuccess() {
            const successMsg = document.getElementById('shareSuccess');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        function updateShareMetaTags() {
            const currentUrl = window.location.href;
            const shareTitle = `${sessionTemplate.className} - Book Your Spot`;
            const shareDescription = `Join us for ${sessionTemplate.className} at ${sessionTemplate.location}. Multiple dates available!`;
            const shareImage = sessionTemplate.imageUrl || '';

            document.getElementById('ogTitle').setAttribute('content', shareTitle);
            document.getElementById('ogDescription').setAttribute('content', shareDescription);
            document.getElementById('ogUrl').setAttribute('content', currentUrl);
            
            if (shareImage) {
                document.getElementById('ogImage').setAttribute('content', shareImage);
                document.getElementById('twitterImage').setAttribute('content', shareImage);
            }

            document.title = shareTitle;
        }

        function onSkillLevelChange() {
            const skillSelect = document.getElementById('skillLevel');
            currentSkillLevel = skillSelect.value;
            
            if (currentSkillLevel) {
                skillSelect.classList.add('valid');
            } else {
                skillSelect.classList.remove('valid');
            }
        }

        function validateSkillLevel() {
            if (!currentSkillLevel || currentSkillLevel === '') {
                alert('Please select your skill level before proceeding.');
                document.getElementById('skillLevel').focus();
                return false;
            }
            return true;
        }

        function updatePricing() {
            if (!selectedSession) {
                document.getElementById('totalPrice').textContent = '¬£0.00';
                return;
            }

            let ticketsTotal = selectedSession.basePrice;
            let addonsTotal = 0;
            const subtotal = ticketsTotal + selectedSession.transactionFee + addonsTotal;

            let html = `
                <div class="price-line"><span>Tickets:</span><span>¬£${ticketsTotal.toFixed(2)}</span></div>
                <div class="price-line"><span>Booking fee:</span><span>¬£${selectedSession.transactionFee.toFixed(2)}</span></div>
            `;

            const discountAmount = calculateDiscount(subtotal);
            const finalTotal = subtotal - discountAmount;

            if (appliedDiscount && discountAmount > 0) {
                const txt = appliedDiscount.type === 'percentage'
                    ? `${appliedDiscount.code} (${appliedDiscount.value}% off)`
                    : `${appliedDiscount.code} (¬£${appliedDiscount.value} off)`;
                html += `<div class="discount-line"><span>${txt}</span><span>-¬£${discountAmount.toFixed(2)}</span></div>`;
            }

            document.getElementById('priceBreakdown').innerHTML = html;
            document.getElementById('totalPrice').textContent = `¬£${finalTotal.toFixed(2)}`;

            const payButton = document.getElementById('payButton');
            if (payButton && !payButton.disabled && selectedSession) {
                if (selectedSession.bookingType === 'direct') {
                    payButton.innerHTML = 'Register Interest';
                } else {
                    payButton.innerHTML = finalTotal === 0 ? 'Register Interest' : `Pay ¬£${finalTotal.toFixed(2)}`;
                }
            }
        }

        function calculateDiscount(subtotal) {
            if (!appliedDiscount) return 0;
            if (appliedDiscount.type === 'percentage') return subtotal * (appliedDiscount.value / 100);
            if (appliedDiscount.type === 'fixed') return Math.min(appliedDiscount.value, subtotal);
            return 0;
        }

        async function applyDiscountCode() {
            const codeInput = document.getElementById('discountCode');
            const applyBtn = document.getElementById('applyDiscountBtn');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showDiscountMessage('Please enter a discount code.', 'error');
                return;
            }

            applyBtn.disabled = true;
            applyBtn.textContent = 'Checking...';
            
            try {
                const discountUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Discount Codes!A:F?key=${API_KEY}`;
                const response = await fetch(discountUrl);
                
                if (!response.ok) throw new Error('Unable to verify discount code');
                
                const data = await response.json();
                const rows = data.values || [];
                let discountFound = null;

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row[0] && row[0].toUpperCase() === code && row[3] === 'yes') {
                        discountFound = {
                            code: row[0],
                            type: row[1],
                            value: parseFloat(row[2]) || 0,
                            active: row[3],
                            description: row[4] || '',
                            usageLimit: row[5] || 'unlimited'
                        };
                        break;
                    }
                }

                if (discountFound) {
                    appliedDiscount = discountFound;
                    showDiscountMessage(`${discountFound.description || 'Discount applied successfully!'}`, 'success');
                    codeInput.disabled = true;
                    applyBtn.textContent = 'Applied';
                    updatePricing();
                } else {
                    showDiscountMessage('Invalid or expired discount code.', 'error');
                }
            } catch (e) {
                console.error('Discount code error:', e);
                showDiscountMessage('Unable to verify discount code. Please try again.', 'error');
            } finally {
                if (!appliedDiscount) {
                    applyBtn.disabled = false;
                    applyBtn.textContent = 'Apply';
                }
            }
        }

        function showDiscountMessage(message, type) {
            const el = document.getElementById('discountMessage');
            el.textContent = message;
            el.className = `discount-message discount-${type}`;
            el.style.display = 'block';
        }

        async function processBooking() {
            if (!selectedSession) {
                alert('Please select a date before booking.');
                return;
            }

            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name) {
                alert('Please enter your name');
                return;
            }
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            if (!validateSkillLevel()) {
                return;
            }

            const button = document.getElementById('payButton');
            button.disabled = true;
            button.innerHTML = 'Processing...';

            let totalAmount = selectedSession.basePrice + selectedSession.transactionFee;
            const selectedAddonNames = [];

            const discountAmount = calculateDiscount(totalAmount);
            const finalAmount = totalAmount - discountAmount;

            console.log('Processing booking for session:', selectedSession.nbrhId);
            console.log('Date:', selectedSession.date);
            console.log('Skill level:', currentSkillLevel);
            console.log('Booking type:', selectedSession.bookingType);

            const bookingType = selectedSession.bookingType;

            if (bookingType === 'direct') {
                processDirectBooking(name, email, currentSkillLevel, selectedAddonNames, finalAmount);
            } else {
                processStripeBooking(name, email, currentSkillLevel, selectedAddonNames, finalAmount, totalAmount, discountAmount);
            }
        }

        async function processDirectBooking(name, email, skillLevel, selectedAddonNames, finalAmount) {
            try {
                console.log('üéØ Processing DIRECT booking...');
                
                const requestPayload = {
                    eventId: selectedSession.nbrhId,
                    eventName: selectedSession.className,
                    customerName: name,
                    customerEmail: email,
                    skillLevel: skillLevel,
                    amount: finalAmount,
                    addons: selectedAddonNames
                };

                const response = await fetch('/api/create-direct-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                const data = await response.json();
                
                if (data.success && data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                } else {
                    throw new Error(data.error || 'Unable to create direct booking');
                }
            } catch (e) {
                console.error('Direct booking error:', e);
                alert('Unable to process booking. Please try again.');
                const button = document.getElementById('payButton');
                button.disabled = false;
                button.innerHTML = 'Register Interest';
            }
        }

        async function processStripeBooking(name, email, skillLevel, selectedAddonNames, finalAmount, totalAmount, discountAmount) {
            try {
                console.log('üí≥ Processing STRIPE payment booking...');
                
                const requestPayload = {
                    eventId: selectedSession.nbrhId,
                    eventName: selectedSession.className,
                    customerName: name,
                    customerEmail: email,
                    skillLevel: skillLevel,
                    amount: finalAmount,
                    originalAmount: totalAmount,
                    discountCode: appliedDiscount ? appliedDiscount.code : null,
                    discountAmount: discountAmount,
                    addons: selectedAddonNames,
                    stripeMetadata: {
                        event_id: selectedSession.nbrhId,
                        event_name: selectedSession.className,
                        customer_name: name,
                        customer_email: email,
                        skill_level: skillLevel,
                        addons_selected: selectedAddonNames.join(', '),
                        amount_paid: Number(finalAmount.toFixed(2))
                    }
                };

                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('Unable to create checkout session');
                }
            } catch (e) {
                console.error('Stripe booking error:', e);
                alert('Unable to process booking. Please try again.');
                const button = document.getElementById('payButton');
                button.disabled = false;
                updatePricing();
            }
        }

        function parseUKDate(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0]) - 1;
                const day = parseInt(parts[1]);
                let year = parseInt(parts[2]);
                
                if (year < 100) {
                    year += 2000;
                }
                
                return new Date(year, month, day);
            }
            return new Date(dateStr);
        }

        function formatDate(dateStr) {
            const date = parseUKDate(dateStr);
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-GB', opts);
        }

        function formatTimeDisplay(startTime, endTime) {
            if (!endTime || endTime.trim() === '') {
                return startTime;
            }
            return `${startTime} - ${endTime}`;
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            const err = document.getElementById('error');
            err.style.display = 'block';
            err.textContent = msg;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const discountInput = document.getElementById('discountCode');
            if (discountInput) {
                discountInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') applyDiscountCode();
                });
            }
        });
    </script>
</body>
</html>
